<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />  

  <title>Shake It!</title>

  <link rel="shortcut icon" href="/favicon.ico"></link>
  <link rel="apple-touch-icon" href="/apple-touch-icon.png"></link>
  <link rel="stylesheet" href="http://code.jquery.com/mobile/1.0a2/jquery.mobile-1.0a2.min.css" />
  <style type="text/css">
    #scores .ui-bar .time {
      float: left;
    }
    #scores .ui-bar .created_at {
      float: right;
    }
    #game .score {
      color: #999;
      background-color: #FFF;
    }
    .staff {
      /*display: none;*/
    }
  </style>
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.js"></script>
  <script type="text/javascript" src="http://code.jquery.com/mobile/1.0a2/jquery.mobile-1.0a2.min.js"></script>
</head>
<body>
  <!-- HOME -->
  <div data-role="page" id="home">
    <header data-role="header">
      <h1>Twet Bar</h1>
      <a href="#about" data-icon="info" class="ui-btn-right">About</a>
    </header>

    <div data-role="content">
      <a href="#game"   data-role="button" data-icon="star">Start Game</a>
      <a href="#scores" data-role="button" data-icon="grid">Scores</a>
    </div><!-- content -->


    <footer data-role="footer" data-position="fixed"><h4>goodstick.org</h4></footer>
  </div><!-- #home -->

  <!-- SCORES -->
  <div data-role="page" id="scores">
    <header data-role="header">
      <h1>Scores</h1>
      <a href="#" data-icon="delete" class="ui-btn-right">Clear</a>
    </header>

    <div data-role="content">
      <p>Loading scores...</p>
    </div><!-- content -->

    <footer data-role="footer"><h4>goodstick.org</h4></footer>
  </div><!-- #scores -->

  <!-- ABOUT -->
  <div data-role="page" id="about">
    <header data-role="header"><h1>About this app</h1></header>

    <div data-role="content">
      <p>test</p>
    </div><!-- content -->

    <footer data-role="footer" data-position="fixed"><h4>goodstick.org</h4></footer>
  </div><!-- #about -->

  <!-- GAME -->
  <div data-role="page" id="game" data-theme="a">
    <header data-role="header"><h1>Shake!</h1></header>

    <div data-role="content">
      <a href="#" data-role="button" id="start_game">Start</a>
      <div class="ui-bar ui-bar-a"><div class="score">0</div></div>
      <div class="stuff"> 
        <audio id="audio" src="pong.mp3" preload="auto">
          Your browser does not support the <code>audio</code> element.  
        </audio> 
      </div>
    </div><!-- content -->

    <footer data-role="footer" data-position="fixed"><h4>goodstick.org</h4></footer>
  </div><!-- #game -->


  <script type="text/javascript">
    function RGB(red, green, blue) {
      return ["rgb(", red.toString(16), ",", green.toString(16), ",", blue.toString(16), ")"].join("");
    }

    var score = 0;
    var old_axis = 0;
    var db;
    var game_started = false;
    var game_start_time;
    var start_button;
    var goal = 100;
    var power_size = 0;

    function game_abort() {
      $(".ui-btn-text", start_button).text("Start");
      game_started = false;
      window.removeEventListener("devicemotion", onMotion);
      window.clearInterval(updateGameScore);
    }
    function game_finish() {
      $(".ui-btn-text", start_button).text("Start");
      game_started = false;
      window.removeEventListener("devicemotion", onMotion);
      window.clearInterval(updateGameScore);
      insertScore(new Date().getTime() - game_start_time, getFormatedNowTime());
    }
    function game_start() {
      play_sound();
      $(".ui-btn-text", start_button).text("Cancel");
      game_started = true;
      score = 0;
      updateGameScore();
      updateGamePower();
      game_start_time = new Date().getTime();
      window.addEventListener("devicemotion", onMotion);
      window.setInterval(updateGamePower, 200);
    }
    function initDb() {
      try {
        if (window.openDatabase) {
          db = openDatabase("twetbar", "1.0", "HTML 5 Device Motion Example", 200000);
          if (db) {
            db.transaction(function(tx) {
              tx.executeSql("CREATE TABLE IF NOT EXISTS Scores (id REAL UNIQUE, score INT, created_at TEXT)", []);
              //, function(tx, result) {
              //  clear();
              //  //xxxx;
              //} );
            } );
          } else {
            // error occurred trying to open DB
          }
        } else {
          // web Databases not supported
        }
      } catch(e) {
        // error occurred during DB init, Web Database supported?
      }
    }
    function insertScore(score, time) {
      db.transaction(function(tx) {
        tx.executeSql('INSERT INTO Scores (score, created_at) VALUES (?, ?)', [score, time]);
      } );
    }
    function loadScores(callback) {
      db.transaction(function(tx) {
        tx.executeSql('SELECT * FROM Scores', [], callback);
      } );
    }
    function clearScores(callback) {
      db.transaction(function(tx) {
        tx.executeSql('DELETE FROM Scores', [], callback);
      } );
    }


    //  <fieldset class="ui-grid-a">
    //    <div class="ui-block-a"><div class="ui-bar ui-bar-e">10:02"</div></div>
    //    <div class="ui-block-b"><div class="ui-bar ui-bar-e">2010-10-20 20:30</div></div>
    //  </fieldset>
    function renderScores(tx, rs) {
      e = $("#scores div[data-role=content]");
      e.empty();

      var r;
      e.append(renderScoreTitle());
      for (var i=0; i < rs.rows.length; i++) {
        r = rs.rows.item(i);
        e.append(renderScore(r['score'], r['created_at']));
      }
    }
    function renderScoreTitle() {
      var template = '<div class="ui-bar">' +
        '<span class="time"/>' +
        '<span class="created_at"/>' +
      '</div>';
      var fieldset = $(template).find(".time").text("Time").end().find(".created_at").text("Date").end();
      return fieldset;
    }
    function renderScore(score, created_at) {
      //var template = '<fieldset class="ui-grid-a">' +
      //  '<div class="ui-block-a"><div class="ui-bar ui-bar-e time"></div></div>' +
      //  '<div class="ui-block-b"><div class="ui-bar ui-bar-e created_at"></div></div>' +
      //'</fieldset>'
      var template = '<div class="ui-bar ui-bar-e">' +
        '<span class="time"/>' +
        '<span class="created_at"/>' +
      '</div>';
      var fieldset = $(template).find(".time").text(formatedScore(score)).end().find(".created_at").text(created_at).end();
      return fieldset;
    }

    function formatedScore(score) {
      var sec  = parseInt(score / 1000, 10) || 0;
      var msec = parseInt(score % 1000, 10) || 0;
      return sec + "'" + msec;
    }

    function getFormatedNowTime() {
      var now = new Date();
      return now.getFullYear() + "/" + now.getMonth() + "/" + now.getDate() + " " + now.getHours() + ":" + now.getMinutes();
    }

    function updateGameScore() {
      var score_width = (score / goal * 100) || 0
      $("#game .score").text(score).css("width", score_width.toString() + "%");
    }
    function updateGamePower() {
      var color = RGB(0, power_size, 0);
      $("#game").css("backgroundImage", "-moz-linear-gradient(center top," + color + ",#222222)");
      $("#game").css("backgroundImage", "-webkit-gradient(linear,left top,left bottom,color-stop(0," + color + "),color-stop(1, #222222))");
      $("#game").css("backgroundColor", color);
    }

    function play_sound() {
      // var sound = $("#audio").get(0);
      // sound.play();
      var sound = new Audio();
      sound.src = "pong.mp3";
      sound.load();
      sound.play();
    }

    function react(isPunch, evt) {
      if (isPunch) {
        score++;
        updateGameScore();

        if (score >= goal) {
          game_finish();
          return;
        }
        power_size += 30;
        if (power_size > 255) {power_size = 255;}
      } else {
        power_size -= 5;
        if (power_size < 0) {power_size = 0;}
      }
    }
    function onMotion(evt) {
      var x = evt.accelerationIncludingGravity.x;
      var y = evt.accelerationIncludingGravity.y;
      var z = evt.accelerationIncludingGravity.z;

      var axis = x;

      if (Math.abs(axis) > 10 && (Math.abs(old_axis - axis) > 5)) {
        react(true, evt);
      } else {
        react(false, evt);
      }
      old_axis = axis;
    }
    $(document).ready(function() {
      initDb();

      $("#game").bind("pageshow", function(event, ui) {
        updateGameScore();
      } ).bind("pagehide", function(event, ui) {
        game_abort();
      } );
      start_button = $("#game #start_game");
      start_button.bind("click", function() {
        if (game_started) {
          game_abort();
        } else {
          game_start();
        }
      } );

      $("#scores").bind("pagebeforeshow", function(event, ui) {
        loadScores(renderScores);
      } ).bind("pagebeforecreate", function(event, ui) {
        loadScores(renderScores);
      } );

      $("#score a[data-icon=delete]").bind("click", function(event) {
        clearScores(renderScores);
      } );
    } );
  </script>
</body>
</html>
